<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Crawler</title>
<meta name="description" content="Coming Soon Responsive Template">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/font-awesome.min.css" rel="stylesheet">
<link href="css/main.css" rel="stylesheet">
<link rel="stylesheet" href="3d/css/style.css" media="screen" type="text/css" />

<style>
.header--raiseUp:hover {
  transform: translate(-9px, -9px);
  text-shadow: 1.5px 1.5px 0 #333, 0px 1.5px 0 #333, -1.5px -1.5px 0 #333, -1.5px -1.5px 0 #333, -1.5px 1.5px 0 #333, 1.5px -1.5px 0 #333, 0.77782px 0.77782px 0 #aaaaaa, 1.55563px 1.55563px 0 #aaaaaa, 2.33345px 2.33345px 0 #aaaaaa, 3.11127px 3.11127px 0 #aaaaaa, 3.88909px 3.88909px 0 #aaaaaa, 4.6669px 4.6669px 0 #aaaaaa, 5.44472px 5.44472px 0 #aaaaaa, 6.22254px 6.22254px 0 #aaaaaa, 7.00036px 7.00036px 0 #aaaaaa, 7.77817px 7.77817px 0 #aaaaaa;
}

.header--shadow:hover {
  transform: translate(5px, 0);
}
.header--shadow.header--raiseUp:hover {
  transform: translate(-5px, 0);
}
</style>

</head>
<body>

<!--main-->
<section class="main">
  <div class="overlay"></div>
  <div class="container">
    <div class="row">
      <div class="col-md-6 col-sm-6"> 
        <!--logo-->
        
        <!--logo end--> 
      </div>
      <div class="col-md-6 col-sm-6"> 
        
        <!--social-->
        <div class="social text-center">
          <ul>
            <li><a href="#" target="_blank"><i class="fa fa-twitter"></i></a></li>
            <li><a href="#" target="_blank"><i class="fa fa-facebook"></i></a></li>
            <li><a href="#" target="_blank"><i class="fa fa-google-plus"></i></a></li>
          </ul>
        </div>
        <!--social end--> 
      </div>
    </div>
    <div class="row">
      <div class="col-md-12"> 
        
        <!--welcome-message-->
        <header class="welcome-message text-center">
          <h1><span class="rotate">Distributed Crawler System , 分布式爬虫系统</span></h1>
		  <script src='3d/js/shine.min.js'></script>

  <script src="3d/js/index.js"></script>
  <script src="/gg_bd_ad_720x90.js" type="text/javascript"></script>
<script src="/follow.js" type="text/javascript"></script>
        </header>
        <!--welcome-message end--> 
        
        <!--sub-form-->
        <div class="sub-form text-center">
          <div class="row">
            <div class="col-md-5 center-block col-sm-8 col-xs-11">
              <form role="form" id="mc-form" method="get" >
                <div class="input-group">
                  <input class="form-control" placeholder="Input a word" name="name">
                  <span class="input-group-btn">
                  <button type="submit" class="btn btn-default" name="subscribe" onclick="start()" >Submit<i class="fa fa-paper-plane"></i></button>
                  </span> </div>
              </form>
              <p id="mc-notification"></p>
            </div>
          </div>
        </div>
        <!--sub-form end--> 
        
        <!-- Countdown-->
        <ul class="countdown text-center">
          <li> <span class="days">00</span>
            <p class="days_ref">words</p>
          </li>
          <li class="seperator">|</li>
          <li> <span class="hours">00</span>
            <p class="hours_ref">urls</p>
          </li>
          <li class="seperator">|</li>
          <li> <span class="minutes">00</span>
            <p class="minutes_ref">minutes</p>
          </li>
          <li class="seperator">|</li>
          <li> <span class="seconds">00</span>
            <p class="seconds_ref">seconds</p>
          </li>
        </ul>
        <!-- Countdown end--> 
        
      </div>
    </div>
  </div>
</section>
<!--main end--> 

<!--Features-->
<div class="copyrights">Collect from <a href="" >Java大作业</a></div>

<section class="features section-spacing" >
  <div class="container" style="height:300px;" id="mycanvas">
    
  </div>
</section>

<!--Features end--> 

<!--Twitter feed-->

<section class="twitter-feed section-spacing text-center">
  <div class="overlay-t"></div>
  <div class="container">
    <div class="row">
      <div class="col-md-7 center-block col-sm-11 col-xs-11">
        <h2>We are exploring more</h2>
        <div class="wow fadeInUp tweet"></div>
      </div>
    </div>
  </div>
</section>

<!--Twitter feed end--> 

<!--CONTACT-->


<!--CONTACT END--> 

<!--site-footer-->
<footer class="site-footer section-spacing">
  <div class="container">
    <div class="row">
      <div class="col-md-12 text-center"> 
        
        <!--social-->
        
        <ul class="social">
          <li class="wow fadeInUp"><a href="#" target="_blank"><i class="fa fa-twitter"></i></a></li>
          <li class="wow fadeInUp"><a href="#" target="_blank"><i class="fa fa-facebook"></i></a></li>
          <li class="wow fadeInUp"><a href="#" target="_blank"><i class="fa fa-google-plus"></i></a></li>
        </ul>
        
        <!--social end--> 
        
        <small class="wow fadeInUp">© 2017 All rights reserved.</small> </div>
    </div>
  </div>
</footer>
<!--site-footer end--> 

<!--PRELOAD-->
<div id="preloader">
  <div id="status"></div>
</div>
<!--end PRELOAD--> 

<script src="js/jquery-1.11.1.min.js"></script> 
<script src="js/jquery.backstretch.min.js"></script> 
<script src="js/wow.min.js"></script> 
<script src="js/retina.min.js"></script> 
<script src="js/tweetie.min.js"></script> 
<script src="js/jquery.downCount.js"></script> 
<script src="js/jquery.form.min.js"></script> 
<script src="js/jquery.validate.min.js"></script> 
<script src="js/jquery.simple-text-rotator.min.js"></script> 
<script src="js/main.js"></script> 

<script src="js/gmap.js"></script>
<script src="effect/js/prefixfree.min.js"></script>
<script>
function getCenterPoint(DOMElement){
  var box=document.getElementById('mycanvas');
  var rect = DOMElement.getBoundingClientRect();
  var rectTop = rect.top;
  var rectLeft = rect.left;
  var ngx = Math.ceil(rectLeft + rect.width);
  var ngy = Math.ceil(rectTop + rect.height);
  var center = [(ngx / 2)+ rectLeft-60,0];
  console.log('rect', rect);
  return center;
}

function getCenterPoints(DOMElement){
  var box=document.getElementById('mycanvas');
  
  var rect = DOMElement.getBoundingClientRect();
  var rectTop = rect.top;
  var rectLeft = rect.left;
  var ngx = Math.ceil(rectLeft + rect.width);
  var ngy = Math.ceil(rectTop + rect.height);
  var center = [((ngx / 2) + rectLeft )/3,0];
  console.log('rect', rect);
  return center;
}

function getCenterPointt(DOMElement){
	var box=document.getElementById('mycanvas');
  var rect = DOMElement.getBoundingClientRect();
  var rectTop = rect.top;
  var rectLeft = rect.left;
  var ngx = Math.ceil(rectLeft + rect.width);
  var ngy = Math.ceil(rectTop + rect.height);
  var center = [((ngx / 2) + rectLeft )*5/3-60, 0];
  console.log('rect', rect);
  return center;
}

// var tagCanvas = document.getElementById('html-canvas');
// console.log("所选DOM的中心点为",getCenterPoint(tagCanvas));

// 获取最大半径
function getMaxRadius(DOMElement, cellSpace){
  var cellSpace = cellSpace || 1;
  var rect = DOMElement.getBoundingClientRect();
  var ngx = Math.ceil(rect.width / cellSpace);
  var ngy = Math.ceil(rect.height / cellSpace);
  var maxRadius = Math.floor(Math.sqrt(ngx * ngx + ngy * ngy));

  return maxRadius;
}

/**
  * 获取圆上每个点的坐标
  @method getCenterPoint
  @param {int} radius 半径
  @param {array} center 类似[11,22]中心点
  @param {int} offsetY y坐标的偏移位置，默认为1
  @return {array} [x, y] 圆上坐标的数组
  */
function getPointsAtRadius(radius, center ,offsetY, multiple){
  // 因为像素是一个正方形，一个正方形的四周有8块正方形可包围。
  var T = radius * 8;
  var t = T;
  var points = [];
  var offsetY = offsetY || 1;
  var multiple = multiple || 30;

  if (radius === 0) {
    points.push([center[0], center[1]]);
  }
  while (t) {
    // 参考http://www.cnblogs.com/xieon1986/archive/2013/01/28/2880367.html
    // 圆上每个点的
    // Y坐标=圆心y坐标 + Math.sin(2*Math.PI / 360) * 半径
    // X坐标=圆心x坐标 + Math.cos(2*Math.PI / 360) * 半径 

    // 弧度=(2*PI/360)*角度
    // 基于圆心的x坐标 X坐标=圆心x坐标 + Math.sin((2*Math.PI / 360) * 1) * 半径 
    // 这里的T同360°的意义
    points.push(
      [
        center[0] + (radius*multiple) * Math.cos( (t * 2 * Math.PI )/ T ),
        center[1] + (radius*multiple) * Math.sin( (t * 2 * Math.PI )/ T ) * offsetY,
      ]
    );

    t = t - 1;
  }

  return points;
}
// console.log('圆上各点坐标', getPointsAtRadius(1,[731.5, 475]));

/**
 * 获取文本的宽高
 @method getCenterPoint
 @param {HTMLDOMElement} DOMElement 通常是一个div
 @return {array} [x, y] 包含中心点坐标的数组
 */
function getTextInfo(word, userCSS){
  var fontSize = getRandomFontSize();
  if(userCSS){
    fontSize = userCSS.fontSize;
  }

  // 通过canvas的API来获取文本的各种信息
  var fcanvas = document.createElement('canvas');
  var fctx = fcanvas.getContext('2d');

  fctx.font = 'normal ' + fontSize + 'px Hiragino Mincho Pro, serif';

  // 通过canvas的measureText方法获取文本 像素级别的宽度
  // http://www.w3school.com.cn/tags/canvas_measuretext.asp
  var fw = fctx.measureText(word).width;
  // 通过字体大小获取高度
  var fh = fontSize;

  return {
    width: Math.ceil(fw),
    height: fh,
    word: word,
    fontSize: fontSize
  }
}
// console.log('你输入的文字长宽为', getTextInfo('你好'));

/**
 * 判断两个矩形是否相交
 * 参考：http://www.cnblogs.com/avril/archive/2012/11/13/2767577.html
 * http://www.cnblogs.com/avril/archive/2013/04/01/2993875.html
 @method isCorssRect
 @param {array} 
 @param {array} 
 @return {bool} true表示有重叠，false表示没有重叠
 */
function isCorssRect(array1, array2){
  var Xa1 = array1[0][0];
  var Ya1 = array1[0][1];
  var Xa2 = array1[1][0];
  var Ya2 = array1[1][1];

  var Xb1 = array2[0][0];
  var Yb1 = array2[0][1];
  var Xb2 = array2[1][0];
  var Yb2 = array2[1][1];

  var Xc1 = Math.max(Xa1,Xb1);
  var Yc1 = Math.max(Ya1,Yb1);
  var Xc2 = Math.min(Xa2,Xb2);
  var Yc2 = Math.min(Ya2,Yb2);

  return (Xc1 <= Xc2 && Yc1 <= Yc2);
}


//获取随机颜色的值
function getRandomColor(){
  var arr = [0,1,2,3,4,5,6,7,8,9,'A','B','C','D','E','F'];
  var color = "#";
  for(i=0;i<6;i++){
    var c = parseInt(Math.random()*16);
    c = arr[c];
    color = color + c;
  }
  return color;
}

// 获取随机文字的大小
function getRandomFontSize(){
  var arr = [17,19,20,23];
  var res = [];
  for (var i = 0, len = arr.length; i < len; i++) {
    var j = Math.floor(Math.random() * arr.length);
    res[i] = arr[j];
    arr.splice(j, 1);
  }
  return res[0];
}

function drawText(position, textInfo, canvas ){
  var span = document.createElement('a');
  span.setAttribute("class","header header--raiseUp header--shadow");
  var styleRules = {
    'position': 'absolute',
    'display': 'block',
    'font': 'normal' + ' '+textInfo.fontSize+'px ' + 'Tahoma',
    'left': position[0] + 'px',
    'top': position[1] +160 + 'px',
    'width': textInfo.width +15+ 'px',
    'height': textInfo.height + 'px',
    'lineHeight': 1,
    'color': getRandomColor(),
  };
  span.textContent = textInfo.word;
  for (var cssProp in styleRules) {
    span.style[cssProp] = styleRules[cssProp];
  }
  canvas.appendChild(span);
}

/**
 * 获取文本的左上右下坐标，
 @param {array} topLeft 类似
 @return {object} textInfo 包含中心点坐标的数组
 */
function getTopLeft(topLeft, textInfo){
  var left1 = topLeft[0];
  var top1 = topLeft[1];
 
  return [
    [left1, top1],
    [left1+ textInfo[0], top1 + textInfo[1]]
  ];
}


// 获取可安置的坐标
function getDrawPosition(textInfo, maxRadius, center, cellSpace ,drawArray){
  var textInfo_width = textInfo.width;
  var textInfo_height = textInfo.height;
  var cellSpace = cellSpace || 10;
  for(var i=0; i<maxRadius; i++){
    var points = getPointsAtRadius(i, center, 0.64, cellSpace);
    pointsLoop:
    for(var j=0; j<points.length; j++){
      var topLeft = getTopLeft(points[j], [textInfo_width, textInfo_height]);
      // 是否和已存的文字碰撞
      for(var z =0 ; z< drawArray.length; z++){
        if(isCorssRect(topLeft, drawArray[z])){
          continue pointsLoop;
        }
        
      }
      drawArray.push(topLeft);
      return points[j];
    }
  }
  return null;
}


function start(){
<?php
   $host        = "host=123.206.72.211";
   $port        = "port=5432";
   $dbname      = "dbname=postgres";
   $credentials = "user=postgres password=java";

   $connect = pg_connect( "$host $port $dbname $credentials"  );
   if(!$connect){
      echo "Error : Unable to open database.<br/>";
   } else {
      //echo "Opened database successfully.<br/>";
   }
   $request = $_GET['name'];//input word
   $type = 1;//word type
   $ulist = array();
   for ($type = 1, $flag = 0; $type <= 3; $type++) { 
      if ($type == 1) {//person
         $sql =<<<EOF
            SELECT * from Persons WHERE person = '$request';
EOF;
      }
      elseif ($type == 2) {//organization
         $sql =<<<EOF
            SELECT * from Organizations WHERE organization = '$request';
EOF;
      }
      elseif ($type == 3) {//location
         $sql =<<<EOF
            SELECT * from Locations WHERE location = '$request';
EOF;
      }
      $result = pg_query($connect, $sql);//the ulists of the key words
      if(pg_num_rows($result) != 0){
         $flag = 1;
         break;
      } 
   }
   if($flag == 0){
	   echo "alert('No Find');";
      $ex = "No";
      exit();
   }
   $i = 0;
   while ($arr = pg_fetch_array($result)) {//select $request from corresponding table
      //echo $arr["ulist"]."<br/>";
      $ulist = explode(",", $arr["ulist"]);//get the ulist
   }      
   $ulist[0] = str_replace("{", "", $ulist[0]);
   $ulist[count($ulist)-1] = str_replace("}", "", $ulist[count($ulist)-1]);
   for ($i=0; $i < count($ulist); $i++) { 
      $ulist[$i] = (int)$ulist[$i];
      //echo $ulist[$i]."<br/>";
   }
   $plist = array();
   $ptemp = array();
   $olist = array();
   $otemp = array();
   $llist = array();
   $ltemp = array();
   $j = 0;
   for ($i=0; $i < count($ulist); $i++) { 
      $sql =<<<EOF
         SELECT * from URLs WHERE id = $ulist[$i];
EOF;
      $result = pg_query($connect, $sql);//get the ulists items
      if(!$result){
         echo pg_last_error($connect);
         exit;
      } 
      while ($arr = pg_fetch_array($result)) {
         //echo $arr[$listname]."<br/>";
         $ptemp = explode(",", $arr["plist"]);
         $ptemp[0] = str_replace("{", "", $ptemp[0]);
         $ptemp[count($ptemp)-1] = str_replace("}", "", $ptemp[count($ptemp)-1]);
         $plist = array_merge($ptemp,$plist);//elements of person urls

         $otemp = explode(",", $arr["olist"]);
         $otemp[0] = str_replace("{", "", $otemp[0]);
         $otemp[count($otemp)-1] = str_replace("}", "", $otemp[count($otemp)-1]);
         $olist = array_merge($otemp,$olist);//elements of organization urls

         $ltemp = explode(",", $arr["llist"]);
         $ltemp[0] = str_replace("{", "", $ltemp[0]);
         $ltemp[count($ltemp)-1] = str_replace("}", "", $ltemp[count($ltemp)-1]);
         $llist = array_merge($ltemp,$llist);//elements of location urls
      }
   }
   /*for ($i=0; $i < count($list); $i++) { 
      echo $list[$i]."<br/>";
   }*/
   $pfinal = array_count_values($plist);
   arsort($pfinal);
   $pfinal = array_keys($pfinal);

   $ofinal = array_count_values($olist);
   arsort($ofinal);
   $ofinal = array_keys($ofinal);

   $lfinal = array_count_values($llist);
   arsort($lfinal);
   $lfinal = array_keys($lfinal);

   $per = array();
   $org = array();
   $loc = array();
   $pointer = array();

   $size = count($pfinal);
   for ($i=0; $i < 50 && $i < $size; $i++) { 
      $pointer[$i] = (int)$pfinal[$i];
   }
   $start = 20;
   for ($i=0,$j=0; $i < $start && $i < $size; $i++) {      
      $sql =<<<EOF
         SELECT * from Persons WHERE id = $pointer[$i];
EOF;
      $result = pg_query($connect, $sql);
      if(!$result){
         echo pg_last_error($connect);
         exit;
      } 
      $arr = pg_fetch_array($result);
      if ($arr["person"]==null) {
         $start++;
         continue;
      }
      $per[$j++] = urlencode($arr["person"]);
   }

   $size = count($ofinal);
   for ($i=0; $i < 50 && $i < $size; $i++) { 
      $pointer[$i] = (int)$ofinal[$i];
   }
   for ($i=0,$j=0,$start=20; $i < $start && $i < $size; $i++) {
      $sql1 =<<<EOF
         SELECT * from Organizations WHERE id = $pointer[$i];
EOF;
      $result1 = pg_query($connect, $sql1);
      if(!$result1){
         echo pg_last_error($connect);
         exit;
      } 
      $arr = pg_fetch_array($result1);
      //echo $arr["organization"]."<br/>";
      if ($arr["organization"]==null) {
         $start++;
         continue;
      }
      $org[$j++] = urlencode($arr["organization"]);
   }

   $size = count($lfinal);
   for ($i=0; $i < 50 && $i < $size; $i++) { 
      $pointer[$i] = (int)$lfinal[$i];
   }
   for ($i=0,$j=0,$start=20; $i < $start && $i < $size; $i++) { 
      $sql2 =<<<EOF
         SELECT * from Locations WHERE id = $pointer[$i];
EOF;
      $result2 = pg_query($connect, $sql2);
      if(!$result2){
         echo pg_last_error($connect);
         exit;
      } 
      $arr = pg_fetch_array($result2);
      //echo $arr["location"]."<br/>";
      if ($arr["location"]==null) {
         $start++;
         continue;
      }
      $loc[$j++] = urlencode($arr["location"]);
   }
   
   //echo urldecode(json_encode($per));
   //echo urldecode(json_encode($org));
   //echo urldecode(json_encode($loc));
   //echo "Operation done successfully<br/>";
   pg_close($connect);
?> 
  //alert('No find');
  var tagCanvas = document.getElementById('mycanvas');
  var center = getCenterPoint(tagCanvas);
  var centers = getCenterPoints(tagCanvas);
  var centert = getCenterPointt(tagCanvas);
  var cellSpace = 20;
  var maxRadius = getMaxRadius(tagCanvas, cellSpace);
  var data = <?php echo urldecode(json_encode($org)); ?>;
  
  var datas = <?php echo urldecode(json_encode($loc)); ?>;
  var datat = <?php echo urldecode(json_encode($per)); ?>;
  var drawArray = [];
  var tempDrawPositionArray = [];

  for(var i =0; i< data.length; i++){
    var dataItem = data[i];
    var textInfo = getTextInfo(dataItem);
    var drawPosition = null;

    if(i != 0){
      drawPosition = getDrawPosition(textInfo, maxRadius, center, cellSpace, drawArray);
    }
    else{
      textInfo = getTextInfo(dataItem, {fontSize:34});
      drawPosition = getDrawPosition(
        textInfo, 
        maxRadius,
        [center[0]-(textInfo.width/2), center[1]-(textInfo.height/2)], 
        cellSpace, 
        drawArray
      );
    }

    if(drawPosition){
      tempDrawPositionArray.push([drawPosition, textInfo, tagCanvas]);
    }      
      
  }
  
  for(var i =0; i< datas.length; i++){
    var dataItem = datas[i];
    var textInfo = getTextInfo(dataItem);
    var drawPosition = null;

    if(i != 0){
      drawPosition = getDrawPosition(textInfo, maxRadius, centers, cellSpace, drawArray);
    }
    else{
      textInfo = getTextInfo(dataItem, {fontSize:34});
      drawPosition = getDrawPosition(
        textInfo, 
        maxRadius,
        [centers[0]-(textInfo.width/2), centers[1]-(textInfo.height/2)], 
        cellSpace, 
        drawArray
      );
    }

    if(drawPosition){
      tempDrawPositionArray.push([drawPosition, textInfo, tagCanvas]);
    }      
      
  }
  
  for(var i =0; i< datat.length; i++){
    var dataItem = datat[i];
    var textInfo = getTextInfo(dataItem);
    var drawPosition = null;

    if(i != 0){
      drawPosition = getDrawPosition(textInfo, maxRadius, centert, cellSpace, drawArray);
    }
    else{
      textInfo = getTextInfo(dataItem, {fontSize:34});
      drawPosition = getDrawPosition(
        textInfo, 
        maxRadius,
        [centert[0]-(textInfo.width/2), centert[1]-(textInfo.height/2)], 
        cellSpace, 
        drawArray
      );
    }

    if(drawPosition){
      tempDrawPositionArray.push([drawPosition, textInfo, tagCanvas]);
    }      
      
  }
  
  var timer = setInterval(function(){
    var textItem = tempDrawPositionArray.shift();
    if(textItem){
      drawText(textItem[0], textItem[1], textItem[2]);
    }
    else{
      clearInterval(timer);
    }
  }, 0);
}
start();
</script>
</body>
</html>
